#!/usr/bin/env bash
# ai-dev — Unified AI CLI Interface
# Primary: Claude Code (claude.ai subscription — no API key needed)
# Optional: Gemini CLI, ShellGPT (install via: bash setup.sh --with-gemini / --with-sgpt)
# Usage: ai-dev [tool] [options/prompt]
#        ai-dev          — interactive menu
#        ai-dev claude   — pass-through to claude
#        ai-dev gemini   — pass-through to gemini (if installed)
#        ai-dev sgpt     — pass-through to sgpt   (if installed)
#        ai-dev --help   — show help

set -euo pipefail

# ─── Load environment ─────────────────────────────────────────────────────────
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"
if [ -f "$ENV_FILE" ]; then
    set -a
    # shellcheck source=/dev/null
    source "$ENV_FILE"
    set +a
fi

# Load nvm so npm-installed tools are on PATH
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
[ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

# ─── Colors ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# ─── Helpers ──────────────────────────────────────────────────────────────────
command_exists() { command -v "$1" &>/dev/null; }

tool_status() {
    local cmd="$1"
    if command_exists "$cmd"; then
        echo -e "${GREEN}installed${RESET}"
    else
        echo -e "${DIM}not installed${RESET}"
    fi
}

print_banner() {
    echo -e "${BOLD}${CYAN}"
    echo "╔═══════════════════════════════════════════╗"
    echo "║         AI Dev — Unified CLI              ║"
    echo "╚═══════════════════════════════════════════╝"
    echo -e "${RESET}"
}

print_status() {
    echo -e "${BOLD}Tool Status:${RESET}"
    printf "  %-12s %s\n" "claude" "$(tool_status claude)  ${DIM}(primary — uses claude.ai subscription)${RESET}"
    printf "  %-12s %s\n" "gemini" "$(tool_status gemini)  ${DIM}(optional — bash setup.sh --with-gemini)${RESET}"
    printf "  %-12s %s\n" "sgpt"   "$(tool_status sgpt)    ${DIM}(optional — bash setup.sh --with-sgpt)${RESET}"
    echo ""
}

# ─── Help ─────────────────────────────────────────────────────────────────────
usage() {
    print_banner
    echo -e "${BOLD}USAGE${RESET}"
    echo "  ai-dev                           Interactive menu"
    echo "  ai-dev claude [args...]          Run Claude Code"
    echo "  ai-dev gemini [args...]          Run Gemini CLI"
    echo "  ai-dev sgpt   [args...]          Run ShellGPT"
    echo "  ai-dev ask    <prompt>           Send prompt to all tools"
    echo "  ai-dev status                    Show tool & key status"
    echo "  ai-dev setup                     Run setup.sh"
    echo "  ai-dev --help | -h               Show this help"
    echo ""
    echo -e "${BOLD}EXAMPLES${RESET}"
    echo "  ai-dev claude \"explain async/await in JS\""
    echo "  ai-dev ask \"what is a REST API?\"   # sends to all installed tools"
    echo ""
    echo -e "${BOLD}GETTING STARTED${RESET}"
    echo "  Claude uses your claude.ai subscription — no API key needed."
    echo "  Just run: claude   (and log in when prompted)"
    echo ""
    echo -e "${BOLD}OPTIONAL EXTRAS${RESET}"
    echo "  bash $SCRIPT_DIR/setup.sh --with-gemini   # free tier available"
    echo "  bash $SCRIPT_DIR/setup.sh --with-sgpt     # requires OpenAI API key"
    echo ""
    print_status
}

# ─── Interactive Menu ─────────────────────────────────────────────────────────
interactive_menu() {
    print_banner
    print_status

    echo -e "${BOLD}Choose a tool:${RESET}"
    echo "  1) Claude Code    (primary)"
    command_exists gemini && echo "  2) Gemini CLI     (optional)"
    command_exists sgpt   && echo "  3) ShellGPT       (optional)"
    echo "  a) Ask all tools  (broadcast to installed)"
    echo "  s) Status"
    echo "  u) Run setup.sh"
    echo "  q) Quit"
    echo ""
    read -r -p "$(echo -e "${CYAN}Select:${RESET} ")" choice

    case "$choice" in
        1) interactive_tool "claude" ;;
        2) interactive_tool "gemini" ;;
        3) interactive_tool "sgpt" ;;
        a|A) interactive_ask_all ;;
        s|S) print_status ;;
        u|U) bash "$SCRIPT_DIR/setup.sh" ;;
        q|Q) echo "Goodbye."; exit 0 ;;
        *) echo -e "${RED}Invalid choice.${RESET}"; interactive_menu ;;
    esac
}

interactive_tool() {
    local tool="$1"
    if ! command_exists "$tool"; then
        echo -e "${RED}$tool is not installed.${RESET}"
        echo "Run: bash $SCRIPT_DIR/setup.sh --with-$tool"
        return 1
    fi
    echo ""
    echo -e "${DIM}Entering $tool interactive mode. Type 'exit' or Ctrl+C to quit.${RESET}"
    echo ""
    exec "$tool"
}

interactive_ask_all() {
    echo ""
    read -r -p "$(echo -e "${CYAN}Enter your prompt:${RESET} ")" prompt
    if [ -z "$prompt" ]; then
        echo "No prompt entered."; return
    fi
    run_all "$prompt"
}

# ─── Run a single tool ────────────────────────────────────────────────────────
run_tool() {
    local tool="$1"; shift
    if ! command_exists "$tool"; then
        echo -e "${RED}[$tool] not installed.${RESET}" >&2
        echo "Run: bash $SCRIPT_DIR/setup.sh --with-$tool" >&2
        return 1
    fi
    "$tool" "$@"
}

# ─── Broadcast to all tools ───────────────────────────────────────────────────
run_all() {
    local prompt="$*"
    local tools=()
    command_exists claude && tools+=("claude")
    command_exists gemini && tools+=("gemini")
    command_exists sgpt   && tools+=("sgpt")

    if [ ${#tools[@]} -eq 0 ]; then
        echo -e "${RED}No AI tools installed. Run: bash $SCRIPT_DIR/setup.sh${RESET}" >&2
        exit 1
    fi

    for tool in "${tools[@]}"; do
        echo -e "\n${BOLD}${MAGENTA}━━━ $tool ━━━${RESET}"
        case "$tool" in
            claude) claude --print "$prompt" 2>/dev/null || claude "$prompt" ;;
            gemini) gemini -p "$prompt" 2>/dev/null || gemini "$prompt" ;;
            sgpt)   sgpt "$prompt" ;;
        esac
    done
}

# ─── Main dispatcher ──────────────────────────────────────────────────────────
main() {
    # No arguments — interactive menu
    if [ $# -eq 0 ]; then
        interactive_menu
        exit 0
    fi

    local cmd="$1"; shift

    case "$cmd" in
        claude|gemini|sgpt)
            if [ $# -eq 0 ]; then
                interactive_tool "$cmd"
            else
                run_tool "$cmd" "$@"
            fi
            ;;
        ask)
            if [ $# -eq 0 ]; then
                echo -e "${RED}Usage: ai-dev ask <prompt>${RESET}" >&2
                exit 1
            fi
            run_all "$@"
            ;;
        status)
            print_banner
            print_status
            ;;
        setup)
            bash "$SCRIPT_DIR/setup.sh" "$@"
            ;;
        --help|-h|help)
            usage
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${RESET}"
            echo "Run: ai-dev --help"
            exit 1
            ;;
    esac
}

main "$@"
