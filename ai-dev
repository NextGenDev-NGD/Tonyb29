#!/usr/bin/env bash
# ai-dev — Unified AI CLI Interface
# Wraps Claude Code, Gemini CLI, and ShellGPT in one command
# Usage: ai-dev [tool] [options/prompt]
#        ai-dev          — interactive menu
#        ai-dev claude   — pass-through to claude
#        ai-dev gemini   — pass-through to gemini
#        ai-dev sgpt     — pass-through to sgpt
#        ai-dev --help   — show help

set -euo pipefail

# ─── Load environment ─────────────────────────────────────────────────────────
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"
if [ -f "$ENV_FILE" ]; then
    set -a
    # shellcheck source=/dev/null
    source "$ENV_FILE"
    set +a
fi

# Load nvm so npm-installed tools are on PATH
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
[ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"

# ─── Colors ───────────────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# ─── Helpers ──────────────────────────────────────────────────────────────────
command_exists() { command -v "$1" &>/dev/null; }

tool_status() {
    local cmd="$1"
    if command_exists "$cmd"; then
        echo -e "${GREEN}installed${RESET}"
    else
        echo -e "${RED}not found${RESET}"
    fi
}

key_status() {
    local var="$1"
    local val="${!var:-}"
    if [ -n "$val" ] && [ "$val" != "your-${var,,}-here" ] && [[ "$val" != *"your-"* ]]; then
        echo -e "${GREEN}set${RESET}"
    else
        echo -e "${YELLOW}not set${RESET}"
    fi
}

print_banner() {
    echo -e "${BOLD}${CYAN}"
    echo "╔═══════════════════════════════════════════╗"
    echo "║         AI Dev — Unified CLI              ║"
    echo "╚═══════════════════════════════════════════╝"
    echo -e "${RESET}"
}

print_status() {
    echo -e "${BOLD}Tool Status:${RESET}"
    printf "  %-12s %s  (key: %s)\n" \
        "claude" "$(tool_status claude)" "$(key_status ANTHROPIC_API_KEY)"
    printf "  %-12s %s  (key: %s)\n" \
        "gemini" "$(tool_status gemini)" "$(key_status GEMINI_API_KEY)"
    printf "  %-12s %s  (key: %s)\n" \
        "sgpt" "$(tool_status sgpt)" "$(key_status OPENAI_API_KEY)"
    echo ""
}

# ─── Help ─────────────────────────────────────────────────────────────────────
usage() {
    print_banner
    echo -e "${BOLD}USAGE${RESET}"
    echo "  ai-dev                           Interactive menu"
    echo "  ai-dev claude [args...]          Run Claude Code"
    echo "  ai-dev gemini [args...]          Run Gemini CLI"
    echo "  ai-dev sgpt   [args...]          Run ShellGPT"
    echo "  ai-dev ask    <prompt>           Send prompt to all tools"
    echo "  ai-dev status                    Show tool & key status"
    echo "  ai-dev setup                     Run setup.sh"
    echo "  ai-dev --help | -h               Show this help"
    echo ""
    echo -e "${BOLD}EXAMPLES${RESET}"
    echo "  ai-dev claude \"explain async/await in JS\""
    echo "  ai-dev gemini \"summarize today's news\""
    echo "  ai-dev sgpt \"write a Python hello world\""
    echo "  ai-dev ask \"what is a REST API?\"   # sends to all three"
    echo ""
    echo -e "${BOLD}API KEY SETUP${RESET}"
    echo "  Edit ${ENV_FILE}"
    echo "  Get keys at:"
    echo "    Claude:  console.anthropic.com"
    echo "    Gemini:  aistudio.google.com/apikey"
    echo "    OpenAI:  platform.openai.com/api-keys"
    echo ""
    print_status
}

# ─── Interactive Menu ─────────────────────────────────────────────────────────
interactive_menu() {
    print_banner
    print_status

    echo -e "${BOLD}Choose a tool:${RESET}"
    echo "  1) Claude Code    (Anthropic)"
    echo "  2) Gemini CLI     (Google)"
    echo "  3) ShellGPT       (OpenAI)"
    echo "  4) Ask all tools  (broadcast)"
    echo "  5) Status"
    echo "  6) Run setup.sh"
    echo "  q) Quit"
    echo ""
    read -r -p "$(echo -e "${CYAN}Select [1-6/q]:${RESET} ")" choice

    case "$choice" in
        1) interactive_tool "claude" ;;
        2) interactive_tool "gemini" ;;
        3) interactive_tool "sgpt" ;;
        4) interactive_ask_all ;;
        5) print_status ;;
        6) bash "$SCRIPT_DIR/setup.sh" ;;
        q|Q) echo "Goodbye."; exit 0 ;;
        *) echo -e "${RED}Invalid choice.${RESET}"; interactive_menu ;;
    esac
}

interactive_tool() {
    local tool="$1"
    if ! command_exists "$tool"; then
        echo -e "${RED}$tool is not installed. Run: ai-dev setup${RESET}"
        return 1
    fi
    echo ""
    echo -e "${DIM}Entering $tool interactive mode. Type 'exit' or Ctrl+C to quit.${RESET}"
    echo ""
    exec "$tool"
}

interactive_ask_all() {
    echo ""
    read -r -p "$(echo -e "${CYAN}Enter your prompt:${RESET} ")" prompt
    if [ -z "$prompt" ]; then
        echo "No prompt entered."; return
    fi
    run_all "$prompt"
}

# ─── Run a single tool ────────────────────────────────────────────────────────
run_tool() {
    local tool="$1"; shift
    if ! command_exists "$tool"; then
        echo -e "${RED}[$tool] not installed. Run: ai-dev setup${RESET}" >&2
        return 1
    fi
    "$tool" "$@"
}

# ─── Broadcast to all tools ───────────────────────────────────────────────────
run_all() {
    local prompt="$*"
    local tools=()
    command_exists claude && tools+=("claude")
    command_exists gemini && tools+=("gemini")
    command_exists sgpt   && tools+=("sgpt")

    if [ ${#tools[@]} -eq 0 ]; then
        echo -e "${RED}No AI tools installed. Run: ai-dev setup${RESET}" >&2
        exit 1
    fi

    for tool in "${tools[@]}"; do
        echo -e "\n${BOLD}${MAGENTA}━━━ $tool ━━━${RESET}"
        case "$tool" in
            claude) claude --print "$prompt" 2>/dev/null || claude "$prompt" ;;
            gemini) gemini -p "$prompt" 2>/dev/null || gemini "$prompt" ;;
            sgpt)   sgpt "$prompt" ;;
        esac
    done
}

# ─── Main dispatcher ──────────────────────────────────────────────────────────
main() {
    # No arguments — interactive menu
    if [ $# -eq 0 ]; then
        interactive_menu
        exit 0
    fi

    local cmd="$1"; shift

    case "$cmd" in
        claude|gemini|sgpt)
            if [ $# -eq 0 ]; then
                interactive_tool "$cmd"
            else
                run_tool "$cmd" "$@"
            fi
            ;;
        ask)
            if [ $# -eq 0 ]; then
                echo -e "${RED}Usage: ai-dev ask <prompt>${RESET}" >&2
                exit 1
            fi
            run_all "$@"
            ;;
        status)
            print_banner
            print_status
            ;;
        setup)
            bash "$SCRIPT_DIR/setup.sh"
            ;;
        --help|-h|help)
            usage
            ;;
        *)
            echo -e "${RED}Unknown command: $cmd${RESET}"
            echo "Run: ai-dev --help"
            exit 1
            ;;
    esac
}

main "$@"
